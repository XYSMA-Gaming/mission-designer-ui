name: Build & Deploy via FTP

on:
  push:

  # Allow manual triggering from the Actions tab (for any branch)
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    # -------------------------------------------------------------------------
    # Environment-based deployment:
    #   - Pushes to "main"       → uses the "production" GitHub environment
    #   - Pushes to other branches → uses the "test" GitHub environment
    #
    # Each environment must define its own variables and secrets:
    #
    # Per-environment Variables (Settings > Environments > <env> > Variables):
    #   FTP_BACKEND_DIR   FTP path to the PHP backend root
    #                     e.g. production: /domains/game.cserver.ir/public_html/api/
    #                          test:       /domains/test.game.cserver.ir/public_html/api/
    #   FTP_FRONTEND_DIR  FTP path to the built React frontend root
    #                     e.g. production: /domains/game.cserver.ir/public_html/
    #                          test:       /domains/test.game.cserver.ir/public_html/
    #   VITE_API_BASE     URL path the browser uses to reach the PHP backend
    #                     (defaults to /api if not set — correct for both envs
    #                      when each lives on its own domain/subdomain)
    #
    # Per-environment Secrets (Settings > Environments > <env> > Secrets):
    #   DB_HOST, DB_PORT, DB_NAME, DB_USER, DB_PASS
    #
    # Repository Secrets (shared, Settings > Secrets > Actions):
    #   FTP_HOST, FTP_USERNAME, FTP_PASSWORD
    # -------------------------------------------------------------------------
    environment: ${{ github.ref_name == 'main' && 'production' || 'test' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        env:
          # Read from the GitHub environment variable; fall back to /api so
          # local builds and environments that don't set it still work.
          VITE_API_BASE: ${{ vars.VITE_API_BASE || '/api' }}
        run: npm run build

      # -------------------------------------------------------------------------
      # Generate backend/config/config.php from GitHub Secrets so that no real
      # credentials are ever stored in the repository.
      #
      # DB secrets are read from the selected GitHub environment (production or
      # test), so each environment connects to its own database automatically.
      # -------------------------------------------------------------------------
      - name: Generate config.php from secrets
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASS: ${{ secrets.DB_PASS }}
        run: |
          cat > backend/config/config.php << PHP
          <?php
          define('DB_HOST',    '${DB_HOST}');
          define('DB_PORT',    '${DB_PORT}');
          define('DB_NAME',    '${DB_NAME}');
          define('DB_USER',    '${DB_USER}');
          define('DB_PASS',    '${DB_PASS}');
          define('DB_CHARSET', 'utf8mb4');
          PHP

      # -------------------------------------------------------------------------
      # Deploy PHP backend
      # -------------------------------------------------------------------------
      - name: Deploy backend via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server:     ${{ secrets.FTP_HOST }}
          username:   ${{ secrets.FTP_USERNAME }}
          password:   ${{ secrets.FTP_PASSWORD }}
          local-dir:  ./backend/
          server-dir: ${{ vars.FTP_BACKEND_DIR }}
          exclude: |
            **/.git*
            **/.git*/**

      # -------------------------------------------------------------------------
      # Deploy built frontend
      # -------------------------------------------------------------------------
      - name: Deploy frontend via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server:     ${{ secrets.FTP_HOST }}
          username:   ${{ secrets.FTP_USERNAME }}
          password:   ${{ secrets.FTP_PASSWORD }}
          local-dir:  ./dist/
          server-dir: ${{ vars.FTP_FRONTEND_DIR }}
