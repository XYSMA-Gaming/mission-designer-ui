name: Build & Deploy via FTP

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      # -------------------------------------------------------------------------
      # Generate backend/config/config.php from GitHub Secrets so that no real
      # credentials are ever stored in the repository.
      #
      # Required Secrets (Settings > Secrets and variables > Actions > Secrets):
      #   DB_HOST, DB_PORT, DB_NAME, DB_USER, DB_PASS
      #   FTP_HOST, FTP_USERNAME, FTP_PASSWORD
      #
      # Required Variables (Settings > Secrets and variables > Actions > Variables):
      #   FTP_BACKEND_DIR   e.g. /public_html/api/
      #   FTP_FRONTEND_DIR  e.g. /public_html/
      # -------------------------------------------------------------------------
      - name: Generate config.php from secrets
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASS: ${{ secrets.DB_PASS }}
        run: |
          cat > backend/config/config.php << PHP
          <?php
          define('DB_HOST',    '${DB_HOST}');
          define('DB_PORT',    '${DB_PORT}');
          define('DB_NAME',    '${DB_NAME}');
          define('DB_USER',    '${DB_USER}');
          define('DB_PASS',    '${DB_PASS}');
          define('DB_CHARSET', 'utf8mb4');
          PHP

      # -------------------------------------------------------------------------
      # Deploy PHP backend
      # -------------------------------------------------------------------------
      - name: Deploy backend via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server:     ${{ secrets.FTP_HOST }}
          username:   ${{ secrets.FTP_USERNAME }}
          password:   ${{ secrets.FTP_PASSWORD }}
          local-dir:  ./backend/
          server-dir: ${{ vars.FTP_BACKEND_DIR }}
          exclude: |
            **/.git*
            **/.git*/**

      # -------------------------------------------------------------------------
      # Deploy built frontend
      # -------------------------------------------------------------------------
      - name: Deploy frontend via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server:     ${{ secrets.FTP_HOST }}
          username:   ${{ secrets.FTP_USERNAME }}
          password:   ${{ secrets.FTP_PASSWORD }}
          local-dir:  ./dist/
          server-dir: ${{ vars.FTP_FRONTEND_DIR }}
