name: Build & Deploy via FTP

on:
  push:

jobs:
  deploy:
    runs-on: ubuntu-latest

    # -------------------------------------------------------------------------
    # Environment-based deployment:
    #   - Pushes to "main"       → uses the "production" GitHub environment
    #   - Pushes to other branches → uses the "test" GitHub environment
    #
    # Each environment supplies its own DB secrets (DB_HOST, DB_PORT, DB_NAME,
    # DB_USER, DB_PASS).  FTP credentials and base directories are shared as
    # repository-level secrets/variables.
    #
    # Setup checklist (Settings > Environments):
    #   1. Create a "production" environment with DB_HOST, DB_PORT, DB_NAME,
    #      DB_USER, DB_PASS secrets pointing to the production database.
    #   2. Create a "test" environment with DB_HOST, DB_PORT, DB_NAME,
    #      DB_USER, DB_PASS secrets pointing to the test database.
    #   3. Keep FTP_HOST, FTP_USERNAME, FTP_PASSWORD as repository secrets.
    #   4. Keep FTP_BACKEND_DIR, FTP_FRONTEND_DIR as repository variables.
    #
    # Non-main branches deploy to a "test/" subfolder on the FTP server:
    #   backend  → <FTP_BACKEND_DIR>test/
    #   frontend → <FTP_FRONTEND_DIR>test/
    # -------------------------------------------------------------------------
    environment: ${{ github.ref_name == 'main' && 'production' || 'test' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      # -------------------------------------------------------------------------
      # Determine FTP target directories.
      # For non-main branches, append "test/" so the deployment is isolated.
      # -------------------------------------------------------------------------
      - name: Determine FTP target directories
        id: ftp
        run: |
          if [ "${{ github.ref_name }}" = "main" ]; then
            echo "backend_dir=${{ vars.FTP_BACKEND_DIR }}" >> "$GITHUB_OUTPUT"
            echo "frontend_dir=${{ vars.FTP_FRONTEND_DIR }}" >> "$GITHUB_OUTPUT"
          else
            echo "backend_dir=${{ vars.FTP_BACKEND_DIR }}test/" >> "$GITHUB_OUTPUT"
            echo "frontend_dir=${{ vars.FTP_FRONTEND_DIR }}test/" >> "$GITHUB_OUTPUT"
          fi

      # -------------------------------------------------------------------------
      # Generate backend/config/config.php from GitHub Secrets so that no real
      # credentials are ever stored in the repository.
      #
      # DB secrets are read from the selected GitHub environment (production or
      # test), so each environment connects to its own database automatically.
      #
      # Required Secrets (per environment):
      #   DB_HOST, DB_PORT, DB_NAME, DB_USER, DB_PASS
      #
      # Required Secrets (repository level):
      #   FTP_HOST, FTP_USERNAME, FTP_PASSWORD
      #
      # Required Variables (repository level):
      #   FTP_BACKEND_DIR   e.g. /public_html/api/
      #   FTP_FRONTEND_DIR  e.g. /public_html/
      # -------------------------------------------------------------------------
      - name: Generate config.php from secrets
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASS: ${{ secrets.DB_PASS }}
        run: |
          cat > backend/config/config.php << PHP
          <?php
          define('DB_HOST',    '${DB_HOST}');
          define('DB_PORT',    '${DB_PORT}');
          define('DB_NAME',    '${DB_NAME}');
          define('DB_USER',    '${DB_USER}');
          define('DB_PASS',    '${DB_PASS}');
          define('DB_CHARSET', 'utf8mb4');
          PHP

      # -------------------------------------------------------------------------
      # Deploy PHP backend
      # -------------------------------------------------------------------------
      - name: Deploy backend via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server:     ${{ secrets.FTP_HOST }}
          username:   ${{ secrets.FTP_USERNAME }}
          password:   ${{ secrets.FTP_PASSWORD }}
          local-dir:  ./backend/
          server-dir: ${{ steps.ftp.outputs.backend_dir }}
          exclude: |
            **/.git*
            **/.git*/**

      # -------------------------------------------------------------------------
      # Deploy built frontend
      # -------------------------------------------------------------------------
      - name: Deploy frontend via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server:     ${{ secrets.FTP_HOST }}
          username:   ${{ secrets.FTP_USERNAME }}
          password:   ${{ secrets.FTP_PASSWORD }}
          local-dir:  ./dist/
          server-dir: ${{ steps.ftp.outputs.frontend_dir }}
